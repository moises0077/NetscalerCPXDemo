version: '3'

services:
  consul:
    image:  gliderlabs/consul-server:latest
    command: "-server -bootstrap"
    container_name: consul
    ports:
      - "8400:8400"
      - "8500:8500"
      - "53:53/udp"
      - "8301-8302/udp"
      - "8300-8300/tcp"
    labels:
      - SERVICE_IGNORE
  
  sidecar:
    build: ./sidecar
    image: sidecar
    container_name: sidecar
    links:
      - consul
      - cpx
    depends_on:
      - consul
  
  registrator:
    image: gliderlabs/registrator:latest
    command: "-cleanup -resync 5 consul://consul:8500"
    container_name: registrator
    depends_on:
      - consul
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock

  cpx:
    image: store/citrix/netscalercpx:12.0-53.16
    tty: true
    ports:
      - 443
      - 22
      - 8080:8080
      - 80:80
      - 88:88
      - 161/udp
    links:
      - web
    container_name: cpx
    privileged: true
    environment:
      - EULA=yes
      - lb_ip=192.168.6.2

  web:
    image: glazeus/hostname
    ports:
      - 80
    depends_on:
      - consul
    links:
      - consul
